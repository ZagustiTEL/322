<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–∞—Ä–æ–ª–µ–π</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–∞—Ä–æ–ª–µ–π</h1>
            <div class="user-info">
                <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ username }}</span>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">–ù–∞–∑–∞–¥</a>
                <a href="{{ url_for('logout') }}" class="btn btn-logout">–í—ã–π—Ç–∏</a>
            </div>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π -->
        <div class="password-manager-form">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å</h2>
            <form id="passwordForm">
                <div class="form-group">
                    <label for="service">–°–µ—Ä–≤–∏—Å/–°–∞–π—Ç:</label>
                    <input type="text" id="service" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="login">–õ–æ–≥–∏–Ω/Email:</label>
                    <input type="text" id="login" class="form-control" >
                </div>
                
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <div class="password-input-container">
                        <input type="password" id="password" class="form-control" > 
                    </div>
                </div>
                
                <button type="button" onclick="addPasswordEntry()" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
            </form>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π -->
        <div class="password-entries">
            <h2>–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–∞—Ä–æ–ª–∏</h2>
            
            {% if password_entries %}
                <div class="entries-list">
                    <div class="entry-header">
                        <span class="entry-service">–°–µ—Ä–≤–∏—Å</span>
                        <span class="entry-login">–õ–æ–≥–∏–Ω</span>
                        <span class="entry-password">–ü–∞—Ä–æ–ª—å</span>
                        <span class="entry-actions">–î–µ–π—Å—Ç–≤–∏—è</span>
                    </div>
                    
                    {% for entry in password_entries %}
                        <div class="entry-item" id="entry-{{ entry.id }}">
                            <span class="entry-service">{{ entry.service }}</span>
                            <span class="entry-login">{{ entry.login }}</span>
                            <span class="entry-password">
                                <span class="password-hidden">{{ entry.password }}</span>

                            </span>
                            <span class="entry-actions">
                                <button onclick="copyPassword({{ entry.id }})" class="btn btn-copy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                                <button onclick="editEntry({{ entry.id }}, '{{ entry.service }}', '{{ entry.login }}', '{{ entry.password }}')" class="btn btn-edit">‚úèÔ∏è</button>
                                <button onclick="deleteEntry({{ entry.id }})" class="btn btn-delete">üóëÔ∏è</button>
                            </span>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="no-entries">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å!</p>
            {% endif %}
        </div>
    </div>

    <script>
        let editingEntryId = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
        async function addPasswordEntry() {
            const service = document.getElementById('service').value.trim();
            const login = document.getElementById('login').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!service || !login || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }
            
            try {
                const response = await fetch('/add-password-entry', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        service: service,
                        login: login,
                        password: password
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('service').value = '';
                    document.getElementById('login').value = '';
                    document.getElementById('password').value = '';
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏: ' + error.message);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
        function togglePassword(entryId) {
            const passwordHidden = document.querySelector(`#entry-${entryId} .password-hidden`);
            const passwordValue = document.querySelector(`#entry-${entryId} .password-value`);
            const toggleButton = document.querySelector(`#entry-${entryId} .btn-toggle`);
            
            if (passwordHidden.style.display === 'none') {
                passwordHidden.style.display = 'inline';
                passwordValue.style.display = 'none';
                toggleButton.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å';
            } else {
                passwordHidden.style.display = 'none';
                passwordValue.style.display = 'inline';
                toggleButton.textContent = '–°–∫—Ä—ã—Ç—å';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyPassword(entryId) {
            const passwordValue = document.querySelector(`#entry-${entryId} .password-value`).textContent;
            
            navigator.clipboard.writeText(passwordValue).then(() => {
                alert('–ü–∞—Ä–æ–ª—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            }).catch(err => {
                alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + err);
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏
        function editEntry(entryId, service, login, password) {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            document.getElementById('service').value = service;
            document.getElementById('login').value = login;
            document.getElementById('password').value = password;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            editingEntryId = entryId;
            
            // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
            const submitButton = document.querySelector('.password-manager-form .btn-primary');
            submitButton.textContent = '–û–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
            submitButton.onclick = updatePasswordEntry;
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ
            document.getElementById('service').focus();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏
        async function updatePasswordEntry() {
            if (!editingEntryId) return;
            
            const service = document.getElementById('service').value.trim();
            const login = document.getElementById('login').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!service || !login || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }
            
            try {
                const response = await fetch(`/update-password-entry/${editingEntryId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        service: service,
                        login: login,
                        password: password
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                    cancelEdit();
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏: ' + error.message);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ–Ω—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function cancelEdit() {
            editingEntryId = null;
            document.getElementById('service').value = '';
            document.getElementById('login').value = '';
            document.getElementById('password').value = '';
            
            const submitButton = document.querySelector('.password-manager-form .btn-primary');
            submitButton.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
            submitButton.onclick = addPasswordEntry;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏
        async function deleteEntry(entryId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
                try {
                    const response = await fetch(`/delete-password-entry/${entryId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        alert('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!');
                        location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + result.error);
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏: ' + error.message);
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è –≤ —Ñ–æ—Ä–º–µ
        function togglePasswordVisibility(fieldId) {
            const passwordField = document.getElementById(fieldId);
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
            } else {
                passwordField.type = 'password';
            }
        }
    </script>
</body>
</html>